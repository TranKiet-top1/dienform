<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>IDLAND v4 ‚Äî Sky Blue + Doraemon</title>
  <style>
    :root{
      --bg:#e6f6ff; --card:#ffffff; --ink:#0b3a5b;
      --muted:#357aa8; --accent:#0ea5e9; --border:#cfe9f7;
    }
    body{
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg); color:var(--ink); margin:0;
    }
    .wrap{max-width:1200px; margin:auto; padding:24px;}
    .card{
      background:var(--card); padding:16px; border-radius:16px;
      border:1px solid var(--border);
      box-shadow:0 12px 26px rgba(14,165,233,.12);
      margin-bottom:20px;
    }
    textarea,input{
      width:100%; padding:12px; border-radius:12px;
      border:1px solid var(--border); background:#f7fcff;
    }
    pre{
      white-space:pre-wrap; background:#f2fbff; padding:16px;
      border-radius:12px; border:1px solid var(--border);
    }
    .btn{
      padding:10px 16px; border-radius:10px;
      background:var(--accent); color:#fff;
      cursor:pointer; border:1px solid var(--accent);
      margin-right:8px;
    }
    .label{font-size:14px; color:var(--muted); margin:8px 0 4px 0;}
    .row{
      display:flex; gap:6px; align-items:center;
    }
    .row input{flex:1;}
    .smallbtn{
      padding:10px 12px;
      border-radius:10px;
      background:transparent;
      color:var(--ink);
      cursor:pointer;
      border:1px solid var(--border);
    }
  </style>
</head>
<body>
<div class="wrap">

  <h2>ID-LAND Quick Tool v4 (Sky Blue + Doraemon)</h2>
  <!-- ƒê·∫∑t file doraemon.png c√πng th∆∞ m·ª•c ƒë·ªÉ hi·ªÉn th·ªã -->
  <div><img src="doraemon.png" alt="Doraemon" width="80"></div>

  <div class="card">
    <div class="label">ƒêo·∫°n th√¥ng tin th√¥</div>
    <textarea id="raw" placeholder="V√≠ d·ª•:
448 Nguy·ªÖn VƒÉn Kh·ªëi Q.G√≤ V·∫•p
6x50 tr·ªát 5 l·∫ßu TM cho chdv
65tr hh30tr 0903389071"></textarea>

    <div class="label">MBKD (ch·ªâ nh·∫≠p ƒëu√¥i, prefix 5678000):</div>
    <div class="row">
      <button class="smallbtn" onclick="decMBKD()">‚àí</button>
      <button class="smallbtn" onclick="incMBKD()">Ôºã</button>
      <input id="mbkdSuffix" placeholder="v√≠ d·ª•: 3080">
    </div>

    <div class="label">D√≤ng üåπ sau g·∫°ch (n·∫øu ƒë·ªÉ tr·ªëng s·∫Ω t·ª± l·∫•y hh... trong ƒëo·∫°n th√¥):</div>
    <input id="term" placeholder="hh 1/2, 1 th√°ng ...">

    <br>
    <button class="btn" onclick="parseRaw()">Chuy·ªÉn ƒë·ªïi</button>
    <button class="btn" onclick="copyOut()">Copy</button>
  </div>

  <div class="card">
    <pre id="out"></pre>
  </div>

</div>

<script>
/* ====== API ONLINE: TH·ª¨ ƒêO√ÅN PH∆Ø·ªúNG T·ª™ ƒê·ªäA CH·ªà ======
   D√πng Nominatim (OpenStreetMap) v·ªõi ∆∞u ti√™n ng√¥n ng·ªØ ti·∫øng Vi·ªát.
   L∆∞u √Ω: n·∫øu API kh√¥ng tr·∫£ ƒë∆∞·ª£c, s·∫Ω tr·∫£ null v√† tool d√πng 'Ph∆∞·ªùng ...'
*/
async function lookupWardVN(addr) {
  try {
    const url =
      "https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&addressdetails=1&q="
      + encodeURIComponent(addr + ", Ho Chi Minh City, Vietnam");

    const res = await fetch(url, {
      headers: { "Accept-Language": "vi" }
    });
    const data = await res.json();
    if (!data || !data.length) return null;

    const a = data[0].address || {};
    const candidates = [
      a.suburb,
      a.city_district,
      a.neighbourhood,
      a.town,
      a.village
    ].filter(Boolean);

    // ∆Øu ti√™n field c√≥ ch·ªØ "Ph∆∞·ªùng"
    for (const v of candidates) {
      if (/ph∆∞·ªùng/i.test(v)) return v; // "Ph∆∞·ªùng 8"
    }
    return candidates[0] || null;
  } catch (e) {
    console.error("L·ªói l·∫•y ph∆∞·ªùng online:", e);
    return null;
  }
}

/* ====== H√ÄM PH·ª§ X·ª¨ L√ù CHU·ªñI ====== */
function extractPhone(t){ let m=t.match(/(0[0-9]{8,10})/); return m?m[1]:""; }
function extractDims(t){ let m=t.match(/(\d+(?:[.,]\d+)?)\s*[x√ó]\s*(\d+(?:[.,]\d+)?)/i); return m?{w:m[1],l:m[2]}:null; }
function extractPrice(t){
  let m=t.match(/(\d+(?:[.,]\d+)?)\s*(?:tr|tri·ªáu)(?!\p{L})/iu);
  return m?m[1].replace(",",".")+" Tri·ªáu/Th√°ng":null;
}
function extractPNWC(t){
  let pn = (t.match(/(\d{1,2})\s*pn\b/i)||[])[1] || null;
  let wc = (t.match(/(\d{1,2})\s*(?:wc|vs|toilet)\b/i)||[])[1] || null;
  return {pn:pn, wc:wc};
}
function detectFeatures(t){
  let f=[];
  if(/v·ªâa\s*h[√™e]|via\s*he/i.test(t)) f.push("V·ªâa h√®");
  if(/\bg√≥c[^\n]*2.*(mt|m·∫∑t\s*ti·ªÅn)/i.test(t)) f.push("G√≥c 2MT");
  if(/\b2\s*mt\b|2\s*m·∫∑t\s*ti·ªÅn/i.test(t)) if(!f.includes("G√≥c 2MT")) f.push("2MT");
  if(/\bhxh\b/i.test(t)) f.push("HXH");
  if(/h·∫ªm\s*xe\s*t·∫£i/i.test(t)) f.push("H·∫ªm xe t·∫£i");
  if(/n[∆°o]\s*h[·∫≠a]u/i.test(t)) f.push("N·ªü h·∫≠u");
  if(/vu[√¥o]ng\s*v[∆∞u]c/i.test(t)) f.push("Vu√¥ng v·ª©c");
  return f;
}

// Chu·∫©n ho√° P., Q. th√†nh Ph∆∞·ªùng, Qu·∫≠n
function expandAddress(addr){
  addr = addr.replace(/\bP\.?\s*(\d+)/gi,"Ph∆∞·ªùng $1");
  addr = addr.replace(/\bQ\.?\s*(\d+)/gi,"Qu·∫≠n $1");
  addr = addr.replace(/\bP\.?\s*([A-Za-z√Ä-·ªπ]+)/gi,"Ph∆∞·ªùng $1");
  addr = addr.replace(/\bQ\.?\s*([A-Za-z√Ä-·ªπ]+)/gi,"Qu·∫≠n $1");
  return addr;
}

// Ph√¢n lo·∫°i m·∫∑t ti·ªÅn / h·∫ªm / m·∫∑t ti·ªÅn h·∫ªm
function isHem(address, content){
  let hasSlash = address.includes("/");
  let bigHem = /h·∫ªm\s*xe\s*t·∫£i|\bhxh\b|xe\s*h∆°i|√¥\s*t√¥/i.test(content);
  if(hasSlash && !bigHem) return "h·∫ªm";
  if(bigHem) return "m·∫∑t ti·ªÅn h·∫ªm";
  return "m·∫∑t ti·ªÅn";
}

// MBKD +/- helper
function getSuffix(){ return (document.getElementById('mbkdSuffix').value||'').replace(/\D/g,''); }
function setSuffix(v){ document.getElementById('mbkdSuffix').value = String(Math.max(0, v)); }
function incMBKD(){ let v=parseInt(getSuffix()||'0'); setSuffix(v+1); parseRaw(); }
function decMBKD(){ let v=parseInt(getSuffix()||'0'); setSuffix(Math.max(0,parseInt(getSuffix()||'0')-1)); parseRaw(); }

// B·ªè s·ªë nh√† trong ti√™u ƒë·ªÅ
function removeHouseNumber(addr){
  return addr.replace(/^\s*\d[\d/]*\s+/,"");
}

/* ====== H√ÄM CH√çNH (V4 ‚Äì ASYNC V√å G·ªåI API) ====== */
async function parseRaw(){
  let raw=document.getElementById("raw").value.trim();
  if(!raw){ alert("Ch∆∞a nh·∫≠p d·ªØ li·ªáu"); return; }

  let lines=raw.split(/\n+/);
  let addrRaw=lines[0]||"";

  // B∆∞·ªõc 1: chu·∫©n ho√° P./Q.
  let addr = expandAddress(addrRaw);

  // B∆∞·ªõc 2: n·∫øu c√≥ Qu·∫≠n m√† ch∆∞a c√≥ Ph∆∞·ªùng ‚Üí th·ª≠ g·ªçi API VN
  if(/Qu·∫≠n/i.test(addr) && !/Ph∆∞·ªùng/i.test(addr)){
    const ward = await lookupWardVN(addr);
    if(ward){
      // ch√®n ph∆∞·ªùng v√†o tr∆∞·ªõc Qu·∫≠n
      addr = addr.replace(/(Qu·∫≠n[^,]*)/i, ward + ", $1");
    }else{
      // kh√¥ng ƒëo√°n ƒë∆∞·ª£c th√¨ ƒë·ªÉ Ph∆∞·ªùng ...
      addr = addr.replace(/(Qu·∫≠n[^,]*)/i, "Ph∆∞·ªùng ..., $1");
    }
  }

  // D√≤ng ti√™u ƒë·ªÅ kh√¥ng c√≥ s·ªë nh√†
  let addrTitle = removeHouseNumber(addr);

  let dims = extractDims(raw);
  let price = extractPrice(raw);
  let phone = extractPhone(raw);

  let pnwc = extractPNWC(raw);
  let pnwcText="";
  if(pnwc.pn || pnwc.wc){
    pnwcText = " ("+(pnwc.pn?pnwc.pn+"PN ":"")+(pnwc.wc?pnwc.wc+"WC":"")+")";
    pnwcText = pnwcText.replace(" )",")").replace("( ","(");
  }

  // K·∫øt c·∫•u: l·∫•y line 2 tr·ª´ ph·∫ßn k√≠ch th∆∞·ªõc
  let struct = lines[1] || "";
  if(dims){
    struct = struct.replace(/(\d+(?:[.,]\d+)?)\s*[x√ó]\s*(\d+(?:[.,]\d+)?)/i,"").trim();
  }
  if(struct) struct = struct.charAt(0).toUpperCase() + struct.slice(1);
  struct += pnwcText;

  let hemType = isHem(addrRaw, raw);
  let title =
    hemType==="m·∫∑t ti·ªÅn" ? "Cho Thu√™ Nh√† M·∫∑t Ti·ªÅn " :
    hemType==="m·∫∑t ti·ªÅn h·∫ªm" ? "Cho Thu√™ Nh√† M·∫∑t Ti·ªÅn H·∫ªm " :
    "Cho Thu√™ Nh√† H·∫ªm ";

  let feats = detectFeatures(raw);
  let featLine = feats.length ? "- Ghi ch√∫ hi·ªán tr·∫°ng: " + feats.join("; ") : "";

  // Hoa h·ªìng / term
  let term = document.getElementById("term").value.trim();
  if(!term){
    let m = raw.match(/\b(hh[^\s]*)/i);
    if(m) term = m[1];
  }
  term = term || "1 Th√°ng";

  let mbkd = "MBKD 5678000" + (getSuffix()||"");

  let out = `
‚≠ïID-LAND Business Premises M·∫∑t B·∫±ng Kinh Doanh ‚≠ï

üè†${title}${addrTitle}
- Gi√° Thu√™: ${price||"(ƒêang c·∫≠p nh·∫≠t)"}
- Di·ªán T√≠ch: ${dims?dims.w+"m x "+dims.l+"m":"(ƒêang c·∫≠p nh·∫≠t)"}
- K·∫øt C·∫•u: ${struct}
- H·ª£p ƒê·ªìng D√†i H·∫°n
- ƒê·∫∑t C·ªçc Thanh To√°n: Th·ªèa Thu·∫≠n
- Th·ªùi gian nh·∫≠n nh√†: Ngay Khi K√Ω H·ª£p ƒê·ªìng
- Ph√π h·ª£p kinh doanh nhi·ªÅu ng√†nh ngh·ªÅ
${featLine}

${mbkd}
________________
üåπ ${term}

üìûContact to us ID-LAND Business Premises
ID-LAND Business Premises TP.HCM
ƒê·ªãa ch·ªâ: ${addr}
Sdt: ${phone}`;

  document.getElementById("out").textContent = out.trim();
}

// Copy
function copyOut(){
  navigator.clipboard.writeText(document.getElementById("out").textContent);
  alert("ƒê√£ copy!");
}
</script>

</body>
</html>
